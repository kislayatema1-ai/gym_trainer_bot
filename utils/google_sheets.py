import gspread
from google.oauth2.service_account import Credentials
from config import config
import time

class GoogleSheetsManager:
    def __init__(self):
        self.credentials_file = "credentials.json"
        self.setup_client()
    
    def setup_client(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ Google Sheets"""
        try:
            scopes = [
                "https://www.googleapis.com/auth/spreadsheets",
                "https://www.googleapis.com/auth/drive"
            ]
            creds = Credentials.from_service_account_file(self.credentials_file, scopes=scopes)
            self.client = gspread.authorize(creds)
            print("‚úÖ Google Sheets –∫–ª–∏–µ–Ω—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Google Sheets: {e}")
            self.client = None
    
    def create_training_spreadsheet(self, user_id, user_name):
        """–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç"""
        try:
            if not self.client:
                print("‚ùå –ö–ª–∏–µ–Ω—Ç Google Sheets –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
                return None
            
            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É –ß–ï–†–ï–ó –°–ï–†–í–ò–°–ù–´–ô –ê–ö–ö–ê–£–ù–¢
            sheet_name = f"–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ {user_name} (ID: {user_id})"
            print(f"üîÑ –°–æ–∑–¥–∞—é —Ç–∞–±–ª–∏—Ü—É: {sheet_name}")
            
            sheet = self.client.create(sheet_name)
            
            # –î–∞–µ–º –¥–æ—Å—Ç—É–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ email (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω –≤ –∫–æ–Ω—Ñ–∏–≥–µ)
            try:
                if hasattr(config, 'ADMIN_EMAIL') and config.ADMIN_EMAIL:
                    sheet.share(config.ADMIN_EMAIL, perm_type='user', role='writer')
                    print(f"‚úÖ –î–∞–ª–µ–Ω –¥–æ—Å—Ç—É–ø —Ç—Ä–µ–Ω–µ—Ä—É: {config.ADMIN_EMAIL}")
            except Exception as share_error:
                print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –¥–∞—Ç—å –¥–æ—Å—Ç—É–ø —Ç—Ä–µ–Ω–µ—Ä—É: {share_error}")
            
            # –î–µ–ª–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–æ—Å—Ç—É–ø–Ω–æ–π –ø–æ —Å—Å—ã–ª–∫–µ
            sheet.share(None, perm_type='anyone', role='writer')
            print("‚úÖ –¢–∞–±–ª–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ —Å—Å—ã–ª–∫–µ")
            
            # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –ø–µ—Ä–µ–¥ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º
            time.sleep(2)
            
            # –ó–∞–ø–æ–ª–Ω—è–µ–º –±–∞–∑–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
            worksheet = sheet.sheet1
            worksheet.update('A1', [
                ['–î–µ–Ω—å', '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ', '–í–µ—Å', '–ü–æ–¥—Ö–æ–¥ 1', '–ü–æ–¥—Ö–æ–¥ 2', '–ü–æ–¥—Ö–æ–¥ 3', '–ü–æ–¥—Ö–æ–¥ 4', '–î–∞—Ç–∞', '–ü—Ä–∏–º–µ—á–∞–Ω–∏—è'],
                ['–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö (–ì—Ä—É–¥—å, –¢—Ä–∏—Ü–µ–ø—Å)', '', '', '', '', '', '', '', ''],
                ['', 'üèãÔ∏è –ñ–∏–º —à—Ç–∞–Ω–≥–∏ –ª–µ–∂–∞', '', '', '', '', '', '', ''],
                ['', 'üí™ –†–∞–∑–≤–æ–¥–∫–∏ –≥–∞–Ω—Ç–µ–ª–µ–π', '', '', '', '', '', '', ''],
                ['', '‚¨áÔ∏è –û—Ç–∂–∏–º–∞–Ω–∏—è –Ω–∞ –±—Ä—É—Å—å—è—Ö', '', '', '', '', '', '', ''],
                ['', 'üîΩ –§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∂–∏–º', '', '', '', '', '', '', ''],
                ['–°–†–ï–î–ê (–°–ø–∏–Ω–∞, –ë–∏—Ü–µ–ø—Å)', '', '', '', '', '', '', '', ''],
                ['', 'üìè –¢—è–≥–∞ —à—Ç–∞–Ω–≥–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ', '', '', '', '', '', '', ''],
                ['', '‚¨ÜÔ∏è –ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è', '', '', '', '', '', '', ''],
                ['', 'üìé –¢—è–≥–∞ –≥–∞–Ω—Ç–µ–ª–∏', '', '', '', '', '', '', ''],
                ['', 'üí™ –°–≥–∏–±–∞–Ω–∏—è —Ä—É–∫ —Å–æ —à—Ç–∞–Ω–≥–æ–π', '', '', '', '', '', '', ''],
                ['–ü–Ø–¢–ù–ò–¶–ê (–ù–æ–≥–∏, –ü–ª–µ—á–∏)', '', '', '', '', '', '', '', ''],
                ['', 'ü¶µ –ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è —Å–æ —à—Ç–∞–Ω–≥–æ–π', '', '', '', '', '', '', ''],
                ['', 'üèãÔ∏è –ñ–∏–º –Ω–æ–≥–∞–º–∏', '', '', '', '', '', '', ''],
                ['', 'üìè –ü–æ–¥—ä–µ–º—ã –Ω–∞ –Ω–æ—Å–∫–∏', '', '', '', '', '', '', ''],
                ['', 'üëê –ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π —Å–∏–¥—è', '', '', '', '', '', '', ''],
                ['', 'üìà –ú–∞—Ö–∏ –≥–∞–Ω—Ç–µ–ª—è–º–∏', '', '', '', '', '', '', '']
            ])
            
            # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫
            worksheet.format('A1:I1', {'textFormat': {'bold': True}})
            
            print(f"‚úÖ –¢–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞: {sheet.url}")
            return sheet.url
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã: {e}")
            return None

# –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
sheets_manager = GoogleSheetsManager()